# Test Environment - For physical home server deployment
# Combines local builds with Cloudflare tunnel for external access

networks:
  obtura_test:
    driver: bridge
    name: obtura_test
    driver_opts:
      com.docker.network.bridge.name: obtura_test
    ipam:
      config:
        - subnet: 172.22.0.0/16

services:
  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: obtura-cloudflared
    command: tunnel --config /etc/cloudflared/config.yml --no-autoupdate run
    volumes:
      - ./cloudflared:/etc/cloudflared:ro
    depends_on:
      - traefik
    networks:
      - obtura_test
    restart: unless-stopped

  coredns:
    image: coredns/coredns:latest
    container_name: obtura-coredns
    command: -conf /etc/coredns/Corefile
    volumes:
      - ./infra/dns/Corefile:/etc/coredns/Corefile:ro
    ports:
      - "53:53/udp"
      - "53:53/tcp"
    networks:
      obtura_test:
        ipv4_address: 172.22.0.53
    restart: unless-stopped

  traefik:
    image: traefik:v3.6
    container_name: obtura-traefik
    command:
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      - --providers.docker.endpoint=tcp://docker:2376
      - --providers.docker.tls.cert=/certs/client/client/cert.pem
      - --providers.docker.tls.key=/certs/client/client/key.pem
      - --providers.docker.tls.ca=/certs/client/client/ca.pem
      - --providers.docker.network=obtura_test
      - --entryPoints.web.address=:80
      - --entryPoints.websecure.address=:443
      - --entryPoints.web.http.redirections.entryPoint.to=websecure
      - --entryPoints.web.http.redirections.entryPoint.scheme=https
      - --entryPoints.websecure.http.tls=true
      - --certificatesResolvers.letsencrypt.acme.tlsChallenge=true
      - --certificatesResolvers.letsencrypt.acme.email=${ACME_EMAIL}
      - --certificatesResolvers.letsencrypt.acme.storage=/letsencrypt/acme.json
      - --api.dashboard=true
      - --api.insecure=false
      - --ping=true
      - --log.level=INFO
      - --accesslog=true
      - --accesslog.filepath=/var/log/traefik/access.log
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - docker-certs:/certs/client:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - traefik-letsencrypt:/letsencrypt
      - traefik-logs:/var/log/traefik
      - ./infra/traefik/traefik.yml:/etc/traefik/traefik.yml:ro
      - ./infra/traefik/dynamic:/etc/traefik/dynamic:ro
      - traefik-dynamic:/etc/traefik/dynamic
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.traefik.rule=Host(`traefik.${DOMAIN}`)"
      - "traefik.http.routers.traefik.entrypoints=websecure"
      - "traefik.http.routers.traefik.tls.certresolver=letsencrypt"
      - "traefik.http.routers.traefik.service=api@internal"
      - "traefik.http.routers.traefik.middlewares=auth@docker"
      - "traefik.http.middlewares.auth.basicauth.users=${TRAEFIK_DASHBOARD_AUTH}"
    networks:
      - obtura_test
    depends_on:
      docker-dind:
        condition: service_healthy
      coredns:
        condition: service_started
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8080/ping"]
      interval: 10s
      timeout: 5s
      retries: 3

  frontend:
    build:
      context: ./client-layer/client
      dockerfile: Dockerfile.dev
    container_name: obtura-frontend
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.frontend.rule=Host(`${DOMAIN}`)"
      - "traefik.http.routers.frontend.entrypoints=websecure"
      - "traefik.http.routers.frontend.tls.certresolver=letsencrypt"
      - "traefik.http.routers.frontend.priority=10"
      - "traefik.http.services.frontend.loadbalancer.server.port=3000"
      - "traefik.docker.network=obtura_test"
      - "traefik.http.services.frontend.loadbalancer.healthcheck.path=/api/health"
      - "traefik.http.services.frontend.loadbalancer.healthcheck.interval=10s"
    environment:
      - NODE_ENV=production
      - BACKEND_URL=http://traefik/backend
      - NEXT_PUBLIC_BACKEND_URL=https://${DOMAIN}/backend
      - NEXT_PUBLIC_BUILD_SERVICE_URL=https://${DOMAIN}/build-service/api
      - NEXT_PUBLIC_DEPLOY_SERVICE_URL=https://${DOMAIN}/deploy-service/api
      - NEXT_PUBLIC_PAYMENT_SERVICE_URL=https://${DOMAIN}/payment-service
      - NEXT_PUBLIC_MONITORING_SERVICE_URL=https://${DOMAIN}/monitoring-service
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
      - NEXTAUTH_URL=https://${DOMAIN}
      - AUTH_SECRET=${AUTH_SECRET}
      - CHANGE_GMAIL_SECRET=${CHANGE_GMAIL_SECRET}
      - TEAM_INVITATION_SECRET=${TEAM_INVITATION_SECRET}
      - NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=${STRIPE_PUBLISHABLE_KEY}
      - MONITORING_SERVICE_URL=https://${DOMAIN}/monitoring-service/
    depends_on:
      - traefik
    networks:
      - obtura_test
    restart: unless-stopped

  core-api:
    build:
      context: ./api-layer/core-api
      dockerfile: Dockerfile.dev
    container_name: obtura-core-api
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.core-api.rule=Host(`${DOMAIN}`) && PathPrefix(`/backend`)"
      - "traefik.http.routers.core-api.entrypoints=websecure"
      - "traefik.http.routers.core-api.tls.certresolver=letsencrypt"
      - "traefik.http.routers.core-api.priority=20"
      - "traefik.http.middlewares.strip-backend.stripprefix.prefixes=/backend"
      - "traefik.http.routers.core-api.middlewares=strip-backend"
      - "traefik.http.services.core-api.loadbalancer.server.port=7070"
      - "traefik.docker.network=obtura_test"
      - "traefik.http.services.core-api.loadbalancer.healthcheck.path=/health"
      - "traefik.http.services.core-api.loadbalancer.healthcheck.interval=10s"
    volumes:
      - ./secrets/github-private-key.pem:/app/secrets/github-private-key.pem:ro
    environment:
      - NODE_ENV=production
      - POSTGRESQL_HOST=postgres
      - ENV_ENCRYPTION_KEY=${ENV_ENCRYPTION_KEY}
      - POSTGRESQL_PORT=5432
      - POSTGRESQL_DATABASE=obtura_db
      - POSTGRESQL_USER=${POSTGRES_USER}
      - POSTGRESQL_PASSWORD=${POSTGRES_PASSWORD}
      - REDIS_URL=redis://redis:6379
      - RABBITMQ_PROTOCOL=amqp
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_PORT=5672
      - RABBITMQ_USER=${RABBITMQ_USER}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD}
      - RABBITMQ_VHOST=/
      - RABBITMQ_HEARTBEAT=60
      - RABBITMQ_PREFETCH=10
      - ACCOUNT_SECRET=${AUTH_SECRET}
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - FRONTEND_URL=https://${DOMAIN}
      - EMAIL_USERNAME=${EMAIL_USERNAME}
      - EMAIL_PASS=${EMAIL_PASSWORD}
      - CHANGE_GMAIL_SECRET=${CHANGE_GMAIL_SECRET}
      - TEAM_INVITATION_SECRET=${TEAM_INVITATION_SECRET}
      - GITHUB_APP_ID=${GITHUB_APP_ID}
      - GITHUB_APP_CLIENT_ID=${GITHUB_APP_CLIENT_ID}
      - GITHUB_APP_CLIENT_SECRET=${GITHUB_APP_CLIENT_SECRET}
      - GITHUB_APP_WEBHOOK_SECRET=${GITHUB_APP_WEBHOOK_SECRET}
      - GITHUB_APP_PRIVATE_KEY_PATH=/app/secrets/github-private-key.pem
      - MONITORING_SERVICE_URL=https://${DOMAIN}/monitoring-service
      - DEPLOY_SERVICE_URL=https://${DOMAIN}/deploy-service
    depends_on:
      rabbitmq:
        condition: service_healthy
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      traefik:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - obtura_test
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:7070/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  payment-service:
    build:
      context: ./api-layer/payment-service
      dockerfile: Dockerfile.dev
    container_name: obtura-payment-service
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.payment-service.rule=Host(`${DOMAIN}`) && PathPrefix(`/payment-service`)"
      - "traefik.http.routers.payment-service.entrypoints=websecure"
      - "traefik.http.routers.payment-service.tls.certresolver=letsencrypt"
      - "traefik.http.routers.payment-service.priority=20"
      - "traefik.http.middlewares.strip-payment-service.stripprefix.prefixes=/payment-service"
      - "traefik.http.routers.payment-service.middlewares=strip-payment-service"
      - "traefik.http.services.payment-service.loadbalancer.server.port=5080"
      - "traefik.docker.network=obtura_test"
      - "traefik.http.services.payment-service.loadbalancer.healthcheck.path=/health"
      - "traefik.http.services.payment-service.loadbalancer.healthcheck.interval=10s"
    environment:
      - NODE_ENV=production
      - POSTGRESQL_HOST=postgres
      - ENV_ENCRYPTION_KEY=${ENV_ENCRYPTION_KEY}
      - POSTGRESQL_PORT=5432
      - POSTGRESQL_DATABASE=obtura_db
      - POSTGRESQL_USER=${POSTGRES_USER}
      - POSTGRESQL_PASSWORD=${POSTGRES_PASSWORD}
      - REDIS_URL=redis://redis:6379
      - RABBITMQ_PROTOCOL=amqp
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_PORT=5672
      - RABBITMQ_USER=${RABBITMQ_USER}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD}
      - RABBITMQ_VHOST=/
      - RABBITMQ_HEARTBEAT=60
      - RABBITMQ_PREFETCH=10
      - FRONTEND_URL=https://${DOMAIN}
      - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY}
    depends_on:
      rabbitmq:
        condition: service_healthy
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      traefik:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - obtura_test
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:5080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  build-service:
    build:
      context: ./api-layer/build-service
      dockerfile: Dockerfile.dev
    container_name: obtura-build-service
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.build-service.rule=Host(`${DOMAIN}`) && PathPrefix(`/build-service`)"
      - "traefik.http.routers.build-service.entrypoints=websecure"
      - "traefik.http.routers.build-service.tls.certresolver=letsencrypt"
      - "traefik.http.routers.build-service.priority=20"
      - "traefik.http.middlewares.strip-build-service.stripprefix.prefixes=/build-service"
      - "traefik.http.routers.build-service.middlewares=strip-build-service"
      - "traefik.http.services.build-service.loadbalancer.server.port=5050"
      - "traefik.docker.network=obtura_test"
      - "traefik.http.services.build-service.loadbalancer.healthcheck.path=/health"
      - "traefik.http.services.build-service.loadbalancer.healthcheck.interval=10s"
    volumes:
      - build-service-tmp:/app/tmp
      - docker-certs:/certs/client:ro
    environment:
      - GO_ENV=production
      - ENV_ENCRYPTION_KEY=${ENV_ENCRYPTION_KEY}
      - CORE_API_URL=http://core-api:7070
      - RABBITMQ_URL=${RABBITMQ_URL}
      - POSTGRESQL_HOST=postgres
      - POSTGRESQL_PORT=5432
      - POSTGRESQL_DATABASE=obtura_db
      - POSTGRESQL_USER=${POSTGRES_USER}
      - POSTGRESQL_PASSWORD=${POSTGRES_PASSWORD}
      - REDIS_URL=redis://redis:6379
      - MINIO_ENDPOINT=minio:9000
      - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY}
      - MINIO_SECRET_KEY=${MINIO_SECRET_KEY}
      - MINIO_USE_SSL=false
      - DOCKER_HOST=tcp://docker:2376
      - DOCKER_TLS_VERIFY=1
      - DOCKER_CERT_PATH=/certs/client/client
      - MONITORING_SERVICE_URL=https://${DOMAIN}/monitoring-service
    depends_on:
      docker-dind:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio:
        condition: service_healthy
      traefik:
        condition: service_healthy
      core-api:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - obtura_test
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:5050/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  deploy-service:
    build:
      context: ./api-layer/deploy-service
      dockerfile: Dockerfile.dev
    container_name: obtura-deploy-service
    volumes:
      - deploy-service-tmp:/app/tmp
      - docker-certs:/certs/client:ro
      - traefik-dynamic:/etc/traefik/dynamic
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.deploy-service.rule=Host(`${DOMAIN}`) && PathPrefix(`/deploy-service`)"
      - "traefik.http.routers.deploy-service.entrypoints=websecure"
      - "traefik.http.routers.deploy-service.tls.certresolver=letsencrypt"
      - "traefik.http.routers.deploy-service.priority=20"
      - "traefik.http.middlewares.strip-deploy-service.stripprefix.prefixes=/deploy-service"
      - "traefik.http.routers.deploy-service.middlewares=strip-deploy-service"
      - "traefik.http.services.deploy-service.loadbalancer.server.port=5070"
      - "traefik.docker.network=obtura_test"
      - "traefik.http.services.deploy-service.loadbalancer.healthcheck.path=/health"
      - "traefik.http.services.deploy-service.loadbalancer.healthcheck.interval=10s"
    environment:
      - GO_ENV=production
      - ENV_ENCRYPTION_KEY=${ENV_ENCRYPTION_KEY}
      - CORE_API_URL=http://core-api:7070
      - RABBITMQ_URL=${RABBITMQ_URL}
      - POSTGRESQL_HOST=postgres
      - POSTGRESQL_PORT=5432
      - POSTGRESQL_DATABASE=obtura_db
      - POSTGRESQL_USER=${POSTGRES_USER}
      - POSTGRESQL_PASSWORD=${POSTGRES_PASSWORD}
      - REDIS_URL=redis://redis:6379
      - MINIO_ENDPOINT=minio:9000
      - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY}
      - MINIO_SECRET_KEY=${MINIO_SECRET_KEY}
      - MINIO_USE_SSL=false
      - DOCKER_HOST=tcp://docker:2376
      - DOCKER_TLS_VERIFY=1
      - DOCKER_CERT_PATH=/certs/client/client
      - MONITORING_SERVICE_URL=https://${DOMAIN}/monitoring-service
    depends_on:
      rabbitmq:
        condition: service_healthy
      postgres:
        condition: service_healthy
      docker-dind:
        condition: service_healthy
      traefik:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - obtura_test
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:5070/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  monitoring-service:
    build:
      context: ./api-layer/monitoring-service
      dockerfile: Dockerfile.dev
    container_name: obtura-monitoring-service
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.monitoring-service.rule=Host(`${DOMAIN}`) && PathPrefix(`/monitoring-service`)"
      - "traefik.http.routers.monitoring-service.entrypoints=websecure"
      - "traefik.http.routers.monitoring-service.tls.certresolver=letsencrypt"
      - "traefik.http.routers.monitoring-service.priority=100"
      - "traefik.http.middlewares.monitoring-service-timeout.timeout=3600s"
      - "traefik.http.middlewares.strip-monitoring-service.stripprefix.prefixes=/monitoring-service"
      - "traefik.http.routers.monitoring-service.middlewares=strip-monitoring-service,monitoring-service-timeout"
      - "traefik.http.services.monitoring-service.loadbalancer.server.port=5110"
      - "traefik.docker.network=obtura_test"
      - "traefik.http.services.monitoring-service.loadbalancer.healthcheck.path=/health"
      - "traefik.http.services.monitoring-service.loadbalancer.healthcheck.interval=10s"
    volumes:
      - docker-certs:/certs/client:ro
      - traefik-logs:/var/log/traefik:ro
    environment:
      - GO_ENV=production
      - PORT=5110
      - ENV_ENCRYPTION_KEY=${ENV_ENCRYPTION_KEY}
      - CORE_API_URL=http://core-api:7070
      - RABBITMQ_URL=${RABBITMQ_URL}
      - POSTGRESQL_HOST=postgres
      - POSTGRESQL_PORT=5432
      - POSTGRESQL_DATABASE=obtura_db
      - POSTGRESQL_USER=${POSTGRES_USER}
      - POSTGRESQL_PASSWORD=${POSTGRES_PASSWORD}
      - REDIS_URL=redis://redis:6379
      - MINIO_ENDPOINT=minio:9000
      - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY}
      - MINIO_SECRET_KEY=${MINIO_SECRET_KEY}
      - MINIO_USE_SSL=false
      - DOCKER_HOST=tcp://docker:2376
      - DOCKER_TLS_VERIFY=1
      - DOCKER_CERT_PATH=/certs/client/client
      - MONITORING_SERVICE_URL=https://${DOMAIN}/monitoring-service
    depends_on:
      rabbitmq:
        condition: service_healthy
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio:
        condition: service_healthy
      docker-dind:
        condition: service_healthy
      traefik:
        condition: service_healthy
      core-api:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - obtura_test
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:5110/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  postgres:
    image: postgres:18-alpine
    container_name: obtura-postgres
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=obtura_db
      - POSTGRES_INITDB_ARGS=--encoding=UTF-8
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d obtura_db"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    networks:
      - obtura_test

  redis:
    image: redis:7-alpine
    container_name: obtura-redis
    command: ["redis-server", "--save", "60", "1", "--appendonly", "yes", "--maxmemory", "256mb", "--maxmemory-policy", "allkeys-lru"]
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 5s
    restart: unless-stopped
    networks:
      - obtura_test

  rabbitmq:
    image: rabbitmq:3.13-management-alpine
    container_name: obtura-rabbitmq
    environment:
      - RABBITMQ_DEFAULT_USER=${RABBITMQ_USER}
      - RABBITMQ_DEFAULT_PASS=${RABBITMQ_PASSWORD}
      - RABBITMQ_DEFAULT_VHOST=/
      - RABBITMQ_SERVER_ADDITIONAL_ERL_ARGS=-rabbit heartbeat 60
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    healthcheck:
      test: rabbitmq-diagnostics -q ping
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped
    networks:
      - obtura_test

  minio:
    image: minio/minio:latest
    container_name: obtura-minio
    environment:
      - MINIO_ROOT_USER=${MINIO_ACCESS_KEY}
      - MINIO_ROOT_PASSWORD=${MINIO_SECRET_KEY}
    command: server /data --console-address ":9001"
    volumes:
      - minio_data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    networks:
      - obtura_test

  docker-dind:
    image: docker:29.2-dind
    container_name: obtura-docker-dind
    hostname: docker
    privileged: true
    environment:
      - DOCKER_TLS_CERTDIR=/certs
    volumes:
      - docker-certs:/certs
      - docker-data:/var/lib/docker
    command:
      - --storage-driver=overlay2
      - --max-concurrent-uploads=1
      - --max-concurrent-downloads=3
      - --dns=172.22.0.53
      - --dns=8.8.8.8
      - --dns-search=.
    security_opt:
      - apparmor=unconfined
    tmpfs:
      - /tmp:rw,noexec,nosuid,size=2g
    dns:
      - 172.22.0.53
      - 8.8.8.8
    dns_search:
      - .
    depends_on:
      - coredns
    healthcheck:
      test: ["CMD", "docker", "info"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s
    restart: unless-stopped
    networks:
      obtura_test:
        aliases:
          - docker
          - docker-host

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  rabbitmq_data:
    driver: local
  minio_data:
    driver: local
  docker-certs:
    driver: local
  docker-data:
    driver: local
  traefik-letsencrypt:
    driver: local
  traefik-logs:
    driver: local
  traefik-dynamic:
    driver: local
  build-service-tmp:
    driver: local
  deploy-service-tmp:
    driver: local
