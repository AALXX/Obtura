networks:
  obtura_dev:
    driver: bridge
    name: obtura_dev

services:
  traefik:
    image: traefik:v3.6
    container_name: obtura-traefik
    command:
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      - --providers.docker.endpoint=tcp://docker:2376
      - --providers.docker.tls.cert=/certs/client/client/cert.pem
      - --providers.docker.tls.key=/certs/client/client/key.pem
      - --providers.docker.tls.ca=/certs/client/client/ca.pem
      - --providers.docker.network=obtura_dev 
      - --entryPoints.web.address=:80
      - --api.insecure=true
      - --log.level=INFO  
      - --accesslog=true
    ports:
      - "80:80"     
    volumes:
      - docker-certs:/certs/client:ro            
      - /var/run/docker.sock:/var/run/docker.sock:ro  
      - ./infra/traefik/traefik.yml:/etc/traefik/traefik.yml:ro
    networks:
      - obtura_dev
    depends_on:
      docker-dind:
        condition: service_healthy
    restart: unless-stopped

  frontend:
    build:
      context: ./client-layer/client
      dockerfile: Dockerfile.dev
    container_name: obtura-frontend
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.frontend.rule=Host(`${DOMAIN}`)"
      - "traefik.http.routers.frontend.entrypoints=web"
      - "traefik.http.routers.frontend.priority=10"
      - "traefik.http.services.frontend.loadbalancer.server.port=3000"
      - "traefik.docker.network=obtura_dev"
    ports:
      - "3000:3000"  
    environment:
      - NODE_ENV=production
      - BACKEND_URL=http://traefik/backend
      - NEXT_PUBLIC_BACKEND_URL=${FRONTEND_URL}/backend      
      - NEXT_PUBLIC_BUILD_SERVICE_URL=${FRONTEND_URL}/build-service/api      
      - NEXT_PUBLIC_DEPLOY_SERVICE_URL=${FRONTEND_URL}/deploy-service/api
      - NEXT_PUBLIC_PAYMENT_SERVICE_URL=${FRONTEND_URL}/payment-service
      - NEXT_PUBLIC_MONITORING_SERVICE_URL=${FRONTEND_URL}/monitoring-service
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
      - NEXTAUTH_URL=${FRONTEND_URL}
      - AUTH_SECRET=${AUTH_SECRET}
      - CHANGE_GMAIL_SECRET=${CHANGE_GMAIL_SECRET}
      - TEAM_INVITATION_SECRET=${TEAM_INVITATION_SECRET}
      - NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=${STRIPE_PUBLISHABLE_KEY}
      - MONITORING_SERVICE_URL=${FRONTEND_URL}/monitoring-service/
    depends_on:
      - traefik
    networks:
      - obtura_dev
    restart: unless-stopped

  core-api:
    build:
      context: ./api-layer/core-api
      dockerfile: Dockerfile.dev
    container_name: obtura-core-api
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.core-api.rule=PathPrefix(`/backend`)"
      - "traefik.http.routers.core-api.entrypoints=web"
      - "traefik.http.routers.core-api.priority=20"
      - "traefik.http.middlewares.strip-backend.stripprefix.prefixes=/backend"
      - "traefik.http.routers.core-api.middlewares=strip-backend"  
      - "traefik.http.services.core-api.loadbalancer.server.port=7070"
      - "traefik.docker.network=obtura_dev"
    ports:
      - "7070:7070" 
    volumes:
      - ./secrets/github-private-key.pem:/app/secrets/github-private-key.pem:ro  
    environment:
      - NODE_ENV=production
      - POSTGRESQL_HOST=postgres
      - ENV_ENCRYPTION_KEY=${ENV_ENCRYPTION_KEY}
      - POSTGRESQL_PORT=5432
      - POSTGRESQL_DATABASE=obtura_db
      - POSTGRESQL_USER=alx
      - POSTGRESQL_PASSWORD=${POSTGRESQL_PASSWORD}
      - REDIS_URL=redis://redis:6379
      - RABBITMQ_PROTOCOL=amqp
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_PORT=5672
      - RABBITMQ_USER=${RABBITMQ_USER}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD}
      - RABBITMQ_VHOST=/
      - RABBITMQ_HEARTBEAT=60
      - RABBITMQ_PREFETCH=10
      - ACCOUNT_SECRET=${AUTH_SECRET}
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - FRONTEND_URL=${FRONTEND_URL}
      - EMAIL_USERNAME=${EMAIL_USERNAME}
      - EMAIL_PASS=${EMAIL_PASS}
      - CHANGE_GMAIL_SECRET=${CHANGE_GMAIL_SECRET}
      - TEAM_INVITATION_SECRET=${TEAM_INVITATION_SECRET}
      - GITHUB_APP_ID=${GITHUB_APP_ID}
      - GITHUB_APP_CLIENT_ID=${GITHUB_APP_CLIENT_ID}
      - GITHUB_APP_CLIENT_SECRET=${GITHUB_APP_CLIENT_SECRET}
      - GITHUB_APP_WEBHOOK_SECRET=${GITHUB_APP_WEBHOOK_SECRET}
      - GITHUB_APP_PRIVATE_KEY_PATH=/app/secrets/github-private-key.pem
      - MONITORING_SERVICE_URL=${FRONTEND_URL}/monitoring-service
      - DEPLOY_SERVICE_URL=${FRONTEND_URL}/deploy-service
    depends_on:
      rabbitmq:
        condition: service_healthy
      postgres:
        condition: service_started
      redis:
        condition: service_started
      traefik:
        condition: service_started
    restart: unless-stopped
    networks:
      - obtura_dev

  payment-service:
    build:
      context: ./api-layer/payment-service
      dockerfile: Dockerfile.dev
    container_name: obtura-payment-service
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.payment-service.rule=PathPrefix(`/payment-service`)"
      - "traefik.http.routers.payment-service.entrypoints=web"
      - "traefik.http.routers.payment-service.priority=20"
      - "traefik.http.middlewares.strip-payment-service.stripprefix.prefixes=/payment-service"
      - "traefik.http.routers.payment-service.middlewares=strip-payment-service"
      - "traefik.http.services.payment-service.loadbalancer.server.port=5080"
      - "traefik.docker.network=obtura_dev"
    ports:
      - "5080:5080" 
    environment:
      - NODE_ENV=production
      - POSTGRESQL_HOST=postgres
      - ENV_ENCRYPTION_KEY=${ENV_ENCRYPTION_KEY}
      - POSTGRESQL_PORT=5432
      - POSTGRESQL_DATABASE=obtura_db
      - POSTGRESQL_USER=alx
      - POSTGRESQL_PASSWORD=${POSTGRESQL_PASSWORD}
      - REDIS_URL=redis://redis:6379
      - RABBITMQ_PROTOCOL=amqp
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_PORT=5672
      - RABBITMQ_USER=${RABBITMQ_USER}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD}
      - RABBITMQ_VHOST=/
      - RABBITMQ_HEARTBEAT=60
      - RABBITMQ_PREFETCH=10
      - FRONTEND_URL=${FRONTEND_URL}
      - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY}
    depends_on:
      rabbitmq:
        condition: service_healthy
      postgres:
        condition: service_started
      redis:
        condition: service_started
      traefik:
        condition: service_started
    restart: unless-stopped
    networks:
      - obtura_dev

  build-service:
    build:
      context: ./api-layer/build-service
      dockerfile: Dockerfile.dev
    container_name: obtura-build-service
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.build-service.rule=PathPrefix(`/build-service`)"
      - "traefik.http.routers.build-service.entrypoints=web"
      - "traefik.http.routers.build-service.priority=20"
      - "traefik.http.middlewares.strip-build-service.stripprefix.prefixes=/build-service"
      - "traefik.http.routers.build-service.middlewares=strip-build-service"
      - "traefik.http.services.build-service.loadbalancer.server.port=5050"
      - "traefik.docker.network=obtura_dev"
    ports:
      - "5050:5050"
    volumes:
      - ./api-layer/build-service/tmp:/app/tmp
      - docker-certs:/certs/client:ro
    environment:
      - GO_ENV=production
      - ENV_ENCRYPTION_KEY=${ENV_ENCRYPTION_KEY}
      - CORE_API_URL=http://core-api:7070
      - REGISTRY_USERNAME=${REGISTRY_USERNAME}
      - REGISTRY_PASSWORD=${REGISTRY_PASSWORD}
      - RABBITMQ_URL=amqp://${RABBITMQ_USER}:${RABBITMQ_PASSWORD}@rabbitmq:5672
      - POSTGRESQL_HOST=postgres
      - POSTGRESQL_PORT=5432
      - POSTGRESQL_DATABASE=obtura_db
      - POSTGRESQL_USER=alx
      - POSTGRESQL_PASSWORD=${POSTGRESQL_PASSWORD}
      - REDIS_URL=redis://redis:6379
      - MINIO_ENDPOINT=minio:9000
      - MINIO_ACCESS_KEY=${MINIO_ROOT_USER}
      - MINIO_SECRET_KEY=${MINIO_ROOT_PASSWORD}
      - MINIO_USE_SSL=false
      - DOCKER_HOST=tcp://docker:2376  
      - DOCKER_TLS_VERIFY=1
      - DOCKER_CERT_PATH=/certs/client/client
      - MONITORING_SERVICE_URL=${FRONTEND_URL}/monitoring-service
    depends_on:
      docker-dind: 
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      postgres:
        condition: service_started
      redis:
        condition: service_started
      minio:
        condition: service_started
      traefik:
        condition: service_started
      core-api:  
        condition: service_started
    restart: unless-stopped
    networks:
      - obtura_dev
    
  deploy-service:
    build:
      context: ./api-layer/deploy-service
      dockerfile: Dockerfile.dev
    container_name: obtura-deploy-service
    volumes:
      - ./api-layer/deploy-service/tmp:/app/tmp
      - docker-certs:/certs/client:ro
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.deploy-service.rule=PathPrefix(`/deploy-service`)"
      - "traefik.http.routers.deploy-service.entrypoints=web"
      - "traefik.http.routers.deploy-service.priority=20"
      - "traefik.http.middlewares.strip-deploy-service.stripprefix.prefixes=/deploy-service"
      - "traefik.http.routers.deploy-service.middlewares=strip-deploy-service"
      - "traefik.http.services.deploy-service.loadbalancer.server.port=5070"
      - "traefik.docker.network=obtura_dev"
    ports:
      - "5070:5070"
    environment:
      - GO_ENV=production
      - ENV_ENCRYPTION_KEY=${ENV_ENCRYPTION_KEY}
      - CORE_API_URL=http://core-api:7070
      - REGISTRY_USERNAME=${REGISTRY_USERNAME}
      - REGISTRY_PASSWORD=${REGISTRY_PASSWORD}
      - RABBITMQ_URL=amqp://${RABBITMQ_USER}:${RABBITMQ_PASSWORD}@rabbitmq:5672
      - POSTGRESQL_HOST=postgres
      - POSTGRESQL_PORT=5432
      - POSTGRESQL_DATABASE=obtura_db
      - POSTGRESQL_USER=alx
      - POSTGRESQL_PASSWORD=${POSTGRESQL_PASSWORD}
      - REDIS_URL=redis://redis:6379
      - MINIO_ENDPOINT=minio:9000
      - MINIO_ACCESS_KEY=${MINIO_ROOT_USER}
      - MINIO_SECRET_KEY=${MINIO_ROOT_PASSWORD}
      - MINIO_USE_SSL=false
      - DOCKER_HOST=tcp://docker:2376  
      - DOCKER_TLS_VERIFY=1
      - DOCKER_CERT_PATH=/certs/client/client
      - MONITORING_SERVICE_URL=${FRONTEND_URL}/monitoring-service
    depends_on:
      rabbitmq:
        condition: service_healthy
      postgres:
        condition: service_started
      docker-dind:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - obtura_dev

  postgres:
    image: postgres:18-alpine
    container_name: obtura-postgres
    environment:
      - POSTGRES_USER=alx
      - POSTGRES_PASSWORD=${POSTGRESQL_PASSWORD}
      - POSTGRES_DB=obtura_db
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U alx -d obtura_db"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - obtura_dev

  redis:
    image: redis:7-alpine
    container_name: obtura-redis
    command: ["redis-server", "--save", "60", "1", "--appendonly", "yes"]
    volumes:
      - redis_data:/data
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    restart: unless-stopped
    networks:
      - obtura_dev

  rabbitmq:
    image: rabbitmq:3.13-management-alpine
    container_name: obtura-rabbitmq
    environment:
      - RABBITMQ_DEFAULT_USER=${RABBITMQ_USER}
      - RABBITMQ_DEFAULT_PASS=${RABBITMQ_PASSWORD}
      - RABBITMQ_DEFAULT_VHOST=/
    ports:
      - "5672:5672"   
      - "15672:15672" 
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    healthcheck:
      test: rabbitmq-diagnostics -q ping
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - obtura_dev

  minio:
    image: minio/minio:latest
    container_name: obtura-minio
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000" 
      - "9001:9001" 
    volumes:
      - minio_data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    networks:
      - obtura_dev

  monitoring-service:
    build:
      context: ./api-layer/monitoring-service
      dockerfile: Dockerfile.dev
    container_name: obtura-monitoring-service
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.monitoring-service.rule=PathPrefix(`/monitoring-service`)"
      - "traefik.http.routers.monitoring-service.entrypoints=web"
      - "traefik.http.middlewares.monitoring-service-timeout.timeout=3600s"
      - "traefik.http.routers.monitoring-service.middlewares=strip-monitoring-service,monitoring-service-timeout"
      - "traefik.http.services.monitoring-service.loadbalancer.server.port=5110"
      - "traefik.docker.network=obtura_dev"
    ports:
      - "5110:5110"
    volumes:
      - docker-certs:/certs/client:ro
      - traefik-logs:/var/log/traefik:ro
    environment:
      - GO_ENV=production
      - PORT=5110
      - ENV_ENCRYPTION_KEY=${ENV_ENCRYPTION_KEY}
      - CORE_API_URL=http://core-api:7070
      - RABBITMQ_URL=amqp://${RABBITMQ_USER}:${RABBITMQ_PASSWORD}@rabbitmq:5672
      - POSTGRESQL_HOST=postgres
      - POSTGRESQL_PORT=5432
      - POSTGRESQL_DATABASE=obtura_db
      - POSTGRESQL_USER=alx
      - POSTGRESQL_PASSWORD=${POSTGRESQL_PASSWORD}
      - REDIS_URL=redis://redis:6379
      - MINIO_ENDPOINT=minio:9000
      - MINIO_ACCESS_KEY=${MINIO_ROOT_USER}
      - MINIO_SECRET_KEY=${MINIO_ROOT_PASSWORD}
      - MINIO_USE_SSL=false
      - DOCKER_HOST=tcp://docker:2376  
      - DOCKER_TLS_VERIFY=1
      - DOCKER_CERT_PATH=/certs/client/client
      - MONITORING_SERVICE_URL=${FRONTEND_URL}/monitoring-service
    depends_on:
      rabbitmq:
        condition: service_healthy
      postgres:
        condition: service_started
      redis:
        condition: service_started
      minio:
        condition: service_started
      docker-dind:
        condition: service_healthy
      traefik:
        condition: service_started
      core-api:
        condition: service_started
    restart: unless-stopped
    networks:
      - obtura_dev

  docker-dind:
    image: docker:29.2-dind
    container_name: obtura-docker-dind
    hostname: docker
    privileged: true
    environment:
      - DOCKER_TLS_CERTDIR=/certs
    volumes:
      - docker-certs:/certs
      - docker-data:/var/lib/docker
    ports:
      - "2376:2376"
    command:
      - --storage-driver=overlay2
      - --max-concurrent-uploads=1
      - --max-concurrent-downloads=3
    security_opt:
      - apparmor=unconfined
    tmpfs:
      - /tmp:rw,noexec,nosuid,size=2g
    healthcheck:
      test: ["CMD", "docker", "info"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s
    restart: unless-stopped
    networks:
      obtura_dev:
        aliases:
          - docker

volumes:
  postgres_data:
  redis_data:
  rabbitmq_data:
  minio_data:
  docker-certs:
  docker-data:
  traefik-logs:
